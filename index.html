<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambusa Tracker - Gestione Magazzino Discoteca</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0a0a0a;
            --dark-secondary: #1a1a1a;
            --dark-tertiary: #2a2a2a;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--dark);
            color: var(--light);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(236, 72, 153, 0.2) 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
            padding-bottom: 2px;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--gray);
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(139, 92, 246, 0.1);
            color: var(--light);
        }

        .nav-tab.active {
            color: var(--primary);
            background: rgba(139, 92, 246, 0.2);
            border-bottom: 2px solid var(--primary);
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--light);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--light);
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
        }

        .form-group input,
        .form-group select {
            padding: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .form-group select option {
            background: var(--dark-secondary);
            color: var(--light);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(139, 92, 246, 0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--light);
            white-space: nowrap;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--light);
        }

        tr:hover {
            background: rgba(139, 92, 246, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid;
        }

        .badge-vodka { 
            background: rgba(254, 226, 226, 0.1); 
            color: #fca5a5; 
            border-color: rgba(252, 165, 165, 0.3);
        }

        .badge-gin { 
            background: rgba(219, 234, 254, 0.1); 
            color: #93c5fd; 
            border-color: rgba(147, 197, 253, 0.3);
        }

        .badge-rum { 
            background: rgba(254, 243, 199, 0.1); 
            color: #fcd34d; 
            border-color: rgba(252, 211, 77, 0.3);
        }

        .badge-whisky { 
            background: rgba(253, 230, 138, 0.1); 
            color: #fbbf24; 
            border-color: rgba(251, 191, 36, 0.3);
        }

        .badge-tequila { 
            background: rgba(209, 250, 229, 0.1); 
            color: #6ee7b7; 
            border-color: rgba(110, 231, 183, 0.3);
        }

        .badge-liquori { 
            background: rgba(233, 213, 255, 0.1); 
            color: #c084fc; 
            border-color: rgba(192, 132, 252, 0.3);
        }

        .badge-champagne { 
            background: rgba(252, 231, 243, 0.1); 
            color: #f9a8d4; 
            border-color: rgba(249, 168, 212, 0.3);
        }

        .badge-analcolici { 
            background: rgba(207, 250, 254, 0.1); 
            color: #67e8f9; 
            border-color: rgba(103, 232, 249, 0.3);
        }

        .badge-energy { 
            background: rgba(254, 202, 202, 0.1); 
            color: #fca5a5; 
            border-color: rgba(252, 165, 165, 0.3);
        }

        .badge-succhi { 
            background: rgba(254, 215, 170, 0.1); 
            color: #fdba74; 
            border-color: rgba(253, 186, 116, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid var(--primary);
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--light);
        }

        .stat-card .change {
            font-size: 0.875rem;
            margin-top: 5px;
        }

        .change.positive { color: var(--success); }
        .change.negative { color: var(--danger); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--dark-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--light);
            background: rgba(255, 255, 255, 0.1);
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: #6ee7b7;
            border-color: rgba(110, 231, 183, 0.3);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border-color: rgba(252, 165, 165, 0.3);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            color: #93c5fd;
            border-color: rgba(147, 197, 253, 0.3);
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            border-radius: 9999px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.75rem;
            }
            
            .nav-tabs {
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th.sortable:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        th.sortable::after {
            content: ' ‚Üï';
            opacity: 0.5;
            font-size: 0.8em;
        }

        th.sortable.asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        th.sortable.desc::after {
            content: ' ‚Üì';
            opacity: 1;
        } 
    </style>
</head>‚Ä®<body>
    <div class="header">
        <div class="container">
            <h1>üçæ Cambusa Tracker</h1>
            <p>Sistema completo di gestione magazzino per la tua discoteca</p>
        </div>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
            <button class="nav-tab" data-tab="inventory">üì¶ Giacenza</button>
            <button class="nav-tab" data-tab="movements">üìù Movimenti</button>
            <button class="nav-tab" data-tab="nights">üåô Serate</button>
            <button class="nav-tab" data-tab="products">üçæ Prodotti</button>
            <button class="nav-tab" data-tab="statistics">üìà Statistiche</button>
            <button class="nav-tab" data-tab="reports">üìã Report</button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Valore Totale Magazzino</h3>
                    <div class="value" id="totalValue">‚Ç¨0.00</div>
                    <div class="change positive">Stock attuale</div>
                </div>
                <div class="stat-card">
                    <h3>Ultimo Consumo Serata</h3>
                    <div class="value" id="lastNightConsumption">‚Ç¨0.00</div>
                    <div class="change" id="lastNightDate">-</div>
                </div>
                <div class="stat-card">
                    <h3>Prodotti in Esaurimento</h3>
                    <div class="value" id="lowStock">0</div>
                    <div class="change negative">Riordina subito</div>
                </div>
                <div class="stat-card">
                    <h3>Media Consumi Settimanale</h3>
                    <div class="value" id="weeklyAverage">‚Ç¨0.00</div>
                    <div class="change">Ultimi 7 giorni</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üî• Prodotti Pi√π Consumati (Ultima Settimana)</h2>
                </div>
                <div class="table-container">
                    <table id="topProductsTable">
                        <thead>
                            <tr>
                                <th>Prodotto</th>
                                <th>Categoria</th>
                                <th>Consumo (L)</th>
                                <th>Valore (‚Ç¨)</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <p>Nessun dato disponibile. Inizia registrando i movimenti!</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div class="tab-content" id="inventory">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üì¶ Gestione Giacenza</h2>
                    <div>
                        <button class="btn btn-secondary" onclick="app.showInitialInventoryModal()">‚ûï Giacenza Iniziale</button>
                        <button class="btn btn-primary" onclick="app.showEndOfNightModal()">üåô Fine Serata</button>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" placeholder="Cerca prodotto..." id="inventorySearch">
                </div>
                <div class="table-container">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Prodotto</th>
                                <th>Categoria</th>
                                <th>Formato</th>
                                <th>Prezzo/L</th>
                                <th>Giacenza (L)</th>
                                <th>Valore (‚Ç¨)</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Movements Tab -->
        <div class="tab-content" id="movements">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìù Registro Movimenti</h2>
                    <button class="btn btn-primary" onclick="app.showOrderModal()">‚ûï Nuovo Ordine</button>
<div class="card-header">
                    <h2 class="card-title">üìù Registro Movimenti</h2>
                    <div>
                        <button class="btn btn-primary" onclick="app.showOrderModal()">‚ûï Nuovo Ordine</button>
                        <button class="btn btn-danger" onclick="app.clearAllMovements()">üóëÔ∏è Azzera Tutti i Movimenti</button>
                    </div>
                </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Filtra per tipo</label>
                        <select id="movementTypeFilter">
                            <option value="">Tutti</option>
                            <option value="consumption">Consumo</option>
                            <option value="order">Ordine</option>
                            <option value="adjustment">Rettifica</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data inizio</label>
                        <input type="date" id="movementStartDate">
                    </div>
                    <div class="form-group">
                        <label>Data fine</label>
                        <input type="date" id="movementEndDate">
                    </div>
                </div>
                <div class="table-container">
                    <table id="movementsTable">
                        <thead>
                            <tr>
                                <th>Data/Ora</th>
                                <th>Tipo</th>
                                <th>Prodotto</th>
                                <th>Quantit√† (L)</th>
                                <th>Valore (‚Ç¨)</th>
                                <th>Note</th>
                                <th>Operatore</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Nights Tab -->
        <div class="tab-content" id="nights">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üåô Dettaglio Serate</h2>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 200px;">
                    <div class="form-group">
                        <label>Seleziona Serata</label>
                        <select id="nightSelector" onchange="app.showNightDetails()">
                            <option value="">Seleziona una serata...</option>
                        </select>
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button class="btn btn-danger" onclick="app.deleteNight()" id="deleteNightBtn" style="display: none;">üóëÔ∏è Elimina Serata</button>
                    </div>
                </div>
                <div id="nightDetailsContainer" style="display: none;">
                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-card">
                            <h3>Totale Consumo</h3>
                            <div class="value" id="nightTotalConsumption">‚Ç¨0.00</div>
                        </div>
                        <div class="stat-card">
                            <h3>Bottiglie Consumate</h3>
                            <div class="value" id="nightBottlesCount">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Litri Totali</h3>
                            <div class="value" id="nightTotalLiters">0L</div>
                        </div>
                        <div class="stat-card">
                            <h3>Categoria Top</h3>
                            <div class="value" id="nightTopCategory">-</div>
                        </div>
                    </div>
                    <h3 style="margin-bottom: 20px; color: var(--primary);">üìä Dettaglio Consumi per Prodotto</h3>
                    <div class="search-box">
                        <input type="text" placeholder="Cerca prodotto nella serata..." id="nightProductSearch" onkeyup="app.filterNightProducts()">
                    </div>
                    <div class="table-container">
                        <table id="nightProductsTable">
                            <thead>
                                <tr>
                                    <th>Prodotto</th>
                                    <th>Categoria</th>
                                    <th>Quantit√† (L)</th>
                                    <th>Bottiglie</th>
                                    <th>Valore (‚Ç¨)</th>
                                    <th>% del Totale</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
<!-- Products Tab -->
        <div class="tab-content" id="products">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üçæ Catalogo Prodotti</h2>
                    <button class="btn btn-primary" onclick="app.showAddProductModal()">‚ûï Aggiungi Prodotto</button>
                </div>
                <div class="search-box">
                    <input type="text" placeholder="Cerca prodotto..." id="productSearch">
                </div>
               <div class="table-container">
                        <table id="nightProductsTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="name">Prodotto</th>
                                    <th class="sortable" data-sort="category">Categoria</th>
                                    <th class="sortable" data-sort="quantity">Quantit√† (L)</th>
                                    <th class="sortable" data-sort="bottles">Bottiglie</th>
                                    <th class="sortable" data-sort="value">Valore (‚Ç¨)</th>
                                    <th class="sortable" data-sort="percentage">% del Totale</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
            </div>
        </div>

        <!-- Statistics Tab -->
        <div class="tab-content" id="statistics">
            <div class="card">
                <h2 class="card-title">üìä Statistiche Avanzate</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Periodo</label>
                        <select id="statsPeriod" onchange="app.updateCharts()">
                            <option value="7">Ultima settimana</option>
                            <option value="30">Ultimo mese</option>
                            <option value="90">Ultimi 3 mesi</option>
                            <option value="all">Tutto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Prodotto Specifico (opzionale)</label>
                        <select id="statsProduct" onchange="app.updateCharts()">
                            <option value="">Tutti i prodotti</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">üèÜ Top 20 Prodotti per Consumo</h2>
                <div class="chart-container">
                    <canvas id="topProductsChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">üìà Trend Consumi nel Tempo</h2>
                <div class="chart-container">
                    <canvas id="consumptionTrendChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">ü•ß Distribuzione per Categoria</h2>
                <div class="chart-container">
                    <canvas id="categoryPieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-content" id="reports">
            <div class="card">
                <h2 class="card-title">üìã Genera Report</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tipo Report</label>
                        <select id="reportType">
                            <option value="inventory">Report Inventario</option>
                            <option value="consumption">Report Consumi</option>
                            <option value="night">Report Serata Singola</option>
                            <option value="product">Report per Prodotto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Periodo</label>
                        <select id="reportPeriod">
                            <option value="day">Giornaliero</option>
                            <option value="week">Settimanale</option>
                            <option value="month">Mensile</option>
                            <option value="custom">Personalizzato</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Formato</label>
                        <select id="reportFormat">
                            <option value="csv">CSV (Excel)</option>
                            <option value="json">JSON</option>
                            <option value="txt">TXT</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="app.generateReport()">üì• Genera e Scarica Report</button>
            </div>
            <div class="card">
                <h2 class="card-title">üìÇ Report Recenti</h2>
                <div id="recentReportsContainer">
                    <p style="color: var(--gray); text-align: center; padding: 20px;">
                        I report generati verranno salvati qui per un accesso rapido.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="initialInventoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Inserisci Giacenza Iniziale</h2>
                <button class="modal-close" onclick="app.closeModal('initialInventoryModal')">√ó</button>
            </div>
            <div class="alert alert-info">
                ‚ÑπÔ∏è Inserisci la giacenza iniziale per tutti i prodotti. Puoi aggiornare singoli prodotti in seguito.
            </div>
            <div id="initialInventoryForm"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="app.closeModal('initialInventoryModal')">Annulla</button>
                <button class="btn btn-primary" onclick="app.saveInitialInventory()">Salva Giacenza</button>
            </div>
        </div>
    </div>

    <div class="modal" id="endOfNightModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üåô Registra Fine Serata</h2>
                <button class="modal-close" onclick="app.closeModal('endOfNightModal')">√ó</button>
            </div>
            <div class="alert alert-info">
                ‚ÑπÔ∏è Inserisci la giacenza finale per calcolare i consumi della serata.
            </div>
            <div class="form-group">
                <label>Data Serata</label>
                <input type="date" id="nightDate" value="">
            </div>
            <div id="endOfNightForm"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="app.closeModal('endOfNightModal')">Annulla</button>
                <button class="btn btn-success" onclick="app.saveEndOfNight()">Calcola Consumi</button>
            </div>
        </div>
    </div>

    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Nuovo Ordine</h2>
                <button class="modal-close" onclick="app.closeModal('orderModal')">√ó</button>
            </div>
            <div class="form-group">
                <label>Fornitore</label>
                <input type="text" id="orderSupplier" placeholder="Nome fornitore">
            </div>
            <div class="form-group">
                <label>Data Ordine</label>
                <input type="date" id="orderDate">
            </div>
            <div id="orderItemsContainer">
                <h3>Prodotti Ordinati</h3>
                <div id="orderItems"></div>
                <button class="btn btn-secondary" onclick="app.addOrderItem()">+ Aggiungi Prodotto</button>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="app.closeModal('orderModal')">Annulla</button>
                <button class="btn btn-primary" onclick="app.saveOrder()">Salva Ordine</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Aggiungi Nuovo Prodotto</h2>
                <button class="modal-close" onclick="app.closeModal('addProductModal')">√ó</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Prodotto</label>
                    <input type="text" id="newProductName" placeholder="Es. Vodka Premium">
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="newProductCategory">
                        <option value="vodka">Vodka</option>
                        <option value="gin">Gin</option>
                        <option value="rum">Rum</option>
                        <option value="whisky">Whisky</option>
                        <option value="tequila">Tequila</option>
                        <option value="liquori">Liquori</option>
                        <option value="champagne">Champagne/Spumanti</option>
                        <option value="analcolici">Analcolici</option>
                        <option value="energy">Energy Drink</option>
                        <option value="succhi">Succhi</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Formato (L)</label>
                    <input type="number" id="newProductFormat" step="0.01" placeholder="1.0">
                </div>
                <div class="form-group">
                    <label>Prezzo (‚Ç¨)</label>
                    <input type="number" id="newProductPrice" step="0.01" placeholder="0.00">
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="app.closeModal('addProductModal')">Annulla</button>
                <button class="btn btn-primary" onclick="app.saveNewProduct()">Salva Prodotto</button>
            </div>
        </div>
    </div>

    <!-- Chart.js + JS della tua app -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
        // App principale
        const app = {
            // Dati
            products: [],
            inventory: {},
            movements: [],
            nights: {},
            charts: {},
            nightProductDetails: [],
            currentSort: { column: 'value', direction: 'desc' },
            
            // Inizializzazione
            init() {
                this.loadInitialProducts();
                this.loadFromStorage();
                this.setupEventListeners();
                this.updateAllTables();
                this.updateDashboard();
                this.updateNightSelector();
                this.populateStatsProductSelect();
                
                // Set today's date as default
                document.getElementById('nightDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            },
            
            // Carica prodotti iniziali
            loadInitialProducts() {
                this.products = [
                    // Vodka
                    { id: 1, name: "SKY VODKA BASE", category: "vodka", format: 1, price: 13.70 },
                    { id: 2, name: "RAJSSA VODKA FRAGOLA", category: "vodka", format: 1, price: 7.96 },
                    { id: 3, name: "RAJSSA VODKA MENTA", category: "vodka", format: 1, price: 7.96 },
                    { id: 4, name: "RAJSSA VODKA PESCA", category: "vodka", format: 1, price: 7.96 },
                    { id: 5, name: "VODKA PREMIUM", category: "vodka", format: 1, price: 44.99 },
                    { id: 6, name: "CIROC", category: "vodka", format: 0.7, price: null },
                    { id: 7, name: "SKYY", category: "vodka", format: 0.7, price: 11.40 },
                    { id: 8, name: "GREY GOOSE", category: "vodka", format: 0.7, price: 44.99 },
                    { id: 9, name: "BELVEDERE", category: "vodka", format: 0.7, price: 37.69 },
                    
                    // Gin
                    { id: 10, name: "BICKENS GIN BASE", category: "gin", format: 1, price: 14.70 },
                    { id: 11, name: "BICKENS PINK POMPELMO", category: "gin", format: 0.7, price: 14.50 },
                    { id: 12, name: "BOMBAY", category: "gin", format: 1, price: 24.05 },
                    { id: 13, name: "GIN MARE", category: "gin", format: 1, price: 45.00 },
                    { id: 14, name: "BULLDOG LONDON DRY", category: "gin", format: 1, price: 27.87 },
                    { id: 15, name: "GIN MARE", category: "gin", format: 0.7, price: 34.60 },
                    { id: 16, name: "BOMBAY", category: "gin", format: 0.7, price: 16.90 },
                    { id: 17, name: "HENDRICKS", category: "gin", format: 1, price: 27.50 },
                    { id: 18, name: "BULLDOG LONDON DRY", category: "gin", format: 0.7, price: 22.00 },
                    
                    // Rum
                    { id: 19, name: "KINGSTON RHUM BIANCO BASE", category: "rum", format: 1, price: 16.10 },
                    { id: 20, name: "CPT MORGAN", category: "rum", format: 1, price: 19.50 },
                    { id: 21, name: "BRUGAL", category: "rum", format: 1, price: 23.00 },
                    { id: 22, name: "HAVANA ESPECIAL", category: "rum", format: 1, price: 15.50 },
                    { id: 23, name: "HAVANA7", category: "rum", format: 0.7, price: 27.75 },
                    { id: 24, name: "BRUGAL", category: "rum", format: 0.7, price: 16.60 },
                    
                    // Whisky
                    { id: 25, name: "JACK DANIEL'S WHISKEY", category: "whisky", format: 1, price: 23.30 },
                    { id: 26, name: "JACK HONEY", category: "whisky", format: 0.7, price: 18.00 },
                    { id: 27, name: "JAMESON", category: "whisky", format: 1, price: 14.50 },
                    { id: 28, name: "JACK DANIEL'S WHISKEY", category: "whisky", format: 0.7, price: 19.70 },
                    { id: 29, name: "BLACK LABEL", category: "whisky", format: 1, price: 17.31 },
                    { id: 30, name: "GOLD LABEL", category: "whisky", format: 1, price: null },
                    
                    // Tequila
                    { id: 31, name: "TEQUILA BASE", category: "tequila", format: 1, price: 16.90 },
                    { id: 32, name: "PATRON SILVER", category: "tequila", format: 1, price: 42.50 },
                    { id: 33, name: "PATRON REPOSADO", category: "tequila", format: 1, price: 20.00 },
                    { id: 34, name: "TEQUILA ESPOLON", category: "tequila", format: 1, price: 20.50 },
                    { id: 35, name: "TEQUILA DON JULIO", category: "tequila", format: 1, price: 40.00 },
                    { id: 36, name: "PATRON REPOSADO", category: "tequila", format: 1, price: 37.00 },
                    
                    // Liquori
                    { id: 37, name: "BLU CURACAO", category: "liquori", format: 1, price: 14.10 },
                    { id: 38, name: "TRIPLE SEC", category: "liquori", format: 1, price: 7.50 },
                    { id: 39, name: "MALIBU", category: "liquori", format: 1, price: 17.50 },
                    { id: 40, name: "COCCORUM", category: "liquori", format: 1, price: 9.00 },
                    { id: 41, name: "MIDORI", category: "liquori", format: 0.7, price: 22.00 },
                    { id: 42, name: "MISAKI", category: "liquori", format: 1, price: 12.00 },
                    { id: 43, name: "4BIANCHI", category: "liquori", format: 1, price: 13.00 },
                    { id: 44, name: "APEROL BARBIERI", category: "liquori", format: 1, price: 13.50 },
                    { id: 45, name: "MARTINI ROSSO", category: "liquori", format: 1, price: 10.20 },
                    { id: 46, name: "CAMPARI BITTER", category: "liquori", format: 1, price: 16.80 },
                    { id: 47, name: "MONTENEGRO", category: "liquori", format: 0.7, price: 13.20 },
                    { id: 48, name: "DISARONNO", category: "liquori", format: 1, price: 19.03 },
                    { id: 49, name: "JAGERMEISTER", category: "liquori", format: 1.5, price: 27.90 },
                    { id: 50, name: "JAGER", category: "liquori", format: 1, price: 14.00 },
                    { id: 51, name: "HENNESSY aperto", category: "liquori", format: 1, price: 19.90 },
                    { id: 52, name: "JAGER", category: "liquori", format: 0.7, price: 12.00 },
                    { id: 53, name: "HENNESSY", category: "liquori", format: 1, price: 28.00 },
                    
                    // Champagne/Spumanti
                    { id: 54, name: "MOET IMPERIAL RESERVE", category: "champagne", format: 1, price: 40.00 },
                    { id: 55, name: "FERRARI PERLE", category: "champagne", format: 1, price: 40.10 },
                    { id: 56, name: "BELLA VISTA", category: "champagne", format: 1, price: 30.18 },
                    { id: 57, name: "DOM PERIGNON", category: "champagne", format: 1, price: 215.00 },
                    { id: 58, name: "LUC BELAIRE", category: "champagne", format: 1, price: null },
                    { id: 59, name: "LUC BELAIRE ROS√â", category: "champagne", format: 1, price: null },
                    { id: 60, name: "BOLLINGER", category: "champagne", format: 1, price: null },
                    { id: 61, name: "MOET NIR", category: "champagne", format: 1, price: null },
                    { id: 62, name: "MOET IMPERIAL", category: "champagne", format: 1, price: null },
                    { id: 63, name: "MOET ICE", category: "champagne", format: 1, price: null },
                    { id: 64, name: "FERRARI PERLE", category: "champagne", format: 1, price: 40.10 },
                    { id: 65, name: "BELLAVISTA", category: "champagne", format: 1, price: 30.18 },
                    
                    // Energy Drink
                    { id: 66, name: "REDBULL", category: "energy", format: 1, price: 1.20 },
                    { id: 67, name: "REDBULL ANGURIA", category: "energy", format: 1, price: 1.00 },
                    { id: 68, name: "REDBULL LEMON", category: "energy", format: 1, price: 1.00 },
                    { id: 69, name: "REDBULL TONICA", category: "energy", format: 1, price: 1.00 },
                    
                    // Analcolici
                    { id: 70, name: "TONICA PREMIUM", category: "analcolici", format: 1, price: 1.20 },
                    { id: 71, name: "TONICA", category: "analcolici", format: 1, price: 0.00 },
                    { id: 72, name: "TONICA FUSTO", category: "analcolici", format: 1, price: 62.15 },
                    { id: 73, name: "LEMON PREMIUM", category: "analcolici", format: 1, price: 1.20 },
                    { id: 74, name: "LEMON", category: "analcolici", format: 1, price: 0.00 },
                    { id: 75, name: "LEMON FUSTO", category: "analcolici", format: 1, price: 62.15 },
                    { id: 76, name: "COCA COLA", category: "analcolici", format: 1, price: 1.95 },
                    { id: 77, name: "COCACOLA LATTINA", category: "analcolici", format: 0.33, price: 0.80 },
                    { id: 78, name: "PEPSI FUSTO", category: "analcolici", format: 1, price: 60.39 },
                    { id: 79, name: "GINGER ALE", category: "analcolici", format: 1, price: 0.99 },
                    { id: 80, name: "GINGER BEER", category: "analcolici", format: 1, price: 0.99 },
                    
                    // Succhi
                    { id: 81, name: "CRANBERRY", category: "succhi", format: 1, price: 1.99 },
                    { id: 82, name: "ANANAS", category: "succhi", format: 1, price: 3.58 },
                    { id: 83, name: "ARANCIA", category: "succhi", format: 1, price: 2.73 },
                    { id: 84, name: "SUCCO LIMONE FUSTO", category: "succhi", format: 1, price: 8.45 }
                ];
            },
// Storage
            loadFromStorage() {
                try {
                    const savedInventory = localStorage.getItem('cambusa_inventory');
                    const savedMovements = localStorage.getItem('cambusa_movements');
                    const savedProducts = localStorage.getItem('cambusa_products');
                    const savedNights = localStorage.getItem('cambusa_nights');
                    
                    if (savedInventory) this.inventory = JSON.parse(savedInventory);
                    if (savedMovements) this.movements = JSON.parse(savedMovements);
                    if (savedNights) this.nights = JSON.parse(savedNights);
                    if (savedProducts) {
                        const customProducts = JSON.parse(savedProducts);
                        this.products = [...this.products, ...customProducts];
                    }
                } catch (error) {
                    console.error('Errore nel caricamento dei dati:', error);
                }
            },
            
            saveToStorage() {
                try {
                    localStorage.setItem('cambusa_inventory', JSON.stringify(this.inventory));
                    localStorage.setItem('cambusa_movements', JSON.stringify(this.movements));
                    localStorage.setItem('cambusa_nights', JSON.stringify(this.nights));
                    
                    // Save only custom products
                    const customProducts = this.products.filter(p => p.id > 1000);
                    localStorage.setItem('cambusa_products', JSON.stringify(customProducts));
                } catch (error) {
                    console.error('Errore nel salvataggio dei dati:', error);
                }
            },
            
            // Event Listeners
            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        e.target.classList.add('active');
                        const tabId = e.target.getAttribute('data-tab');
                        document.getElementById(tabId).classList.add('active');
                        
                        if (tabId === 'statistics') {
                            this.updateCharts();
                        }
                    });
                });
                
                // Search functionality
                document.getElementById('inventorySearch').addEventListener('input', (e) => {
                    this.filterTable('inventoryTable', e.target.value);
                });
                
                document.getElementById('productSearch').addEventListener('input', (e) => {
                    this.filterTable('productsTable', e.target.value);
                });
                
                // Movement filters
                document.getElementById('movementTypeFilter').addEventListener('change', () => this.updateMovementsTable());
                document.getElementById('movementStartDate').addEventListener('change', () => this.updateMovementsTable());
                document.getElementById('movementEndDate').addEventListener('change', () => this.updateMovementsTable());
            },
            
            // Table Updates
            updateAllTables() {
                this.updateInventoryTable();
                this.updateProductsTable();
                this.updateMovementsTable();
            },
            
            updateInventoryTable() {
                const tbody = document.querySelector('#inventoryTable tbody');
                tbody.innerHTML = '';
                
                this.products.forEach(product => {
                    const stock = this.inventory[product.id] || 0;
                    const value = stock * (product.price || 0);
                    const pricePerLiter = product.price ? (product.price / product.format).toFixed(2) : '-';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td><span class="badge badge-${product.category}">${this.getCategoryName(product.category)}</span></td>
                        <td>${product.format}L</td>
                        <td>‚Ç¨${pricePerLiter}</td>
                        <td>${stock.toFixed(2)}L</td>
                        <td>‚Ç¨${value.toFixed(2)}</td>
                        <td>${this.getStockStatus(stock, product)}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="app.adjustInventory(${product.id})">
                                ‚úèÔ∏è Modifica
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },
            
            updateProductsTable() {
                const tbody = document.querySelector('#productsTable tbody');
                tbody.innerHTML = '';
                
                this.products.forEach(product => {
                    const pricePerLiter = product.price ? (product.price / product.format).toFixed(2) : '-';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>#${product.id}</td>
                        <td>${product.name}</td>
                        <td><span class="badge badge-${product.category}">${this.getCategoryName(product.category)}</span></td>
                        <td>${product.format}L</td>
                        <td>${product.price ? '‚Ç¨' + product.price.toFixed(2) : '-'}</td>
                        <td>‚Ç¨${pricePerLiter}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="app.editProduct(${product.id})">
                                ‚úèÔ∏è Modifica
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            },
            
            updateMovementsTable() {
                const tbody = document.querySelector('#movementsTable tbody');
                tbody.innerHTML = '';
                
                let filteredMovements = [...this.movements];
                
                // Apply filters
                const typeFilter = document.getElementById('movementTypeFilter').value;
                const startDate = document.getElementById('movementStartDate').value;
                const endDate = document.getElementById('movementEndDate').value;
                
                if (typeFilter) {
                    filteredMovements = filteredMovements.filter(m => m.type === typeFilter);
                }
                
                if (startDate) {
                    filteredMovements = filteredMovements.filter(m => m.date >= startDate);
                }
                
                if (endDate) {
                    filteredMovements = filteredMovements.filter(m => m.date <= endDate);
                }
                
                // Sort by date descending
                filteredMovements.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                filteredMovements.forEach(movement => {
                    const product = this.products.find(p => p.id === movement.productId);
                    const value = Math.abs(movement.quantity) * (product?.price || 0);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(movement.date).toLocaleString('it-IT')}</td>
                        <td>${this.getMovementTypeName(movement.type)}</td>
                        <td>${product?.name || 'Prodotto rimosso'}</td>
                        <td>${movement.quantity > 0 ? '+' : ''}${movement.quantity.toFixed(2)}L</td>
                        <td>‚Ç¨${value.toFixed(2)}</td>
                        <td>${movement.note || '-'}</td>
                        <td>${movement.operator || 'Sistema'}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="app.deleteMovement('${movement.id}')">
                                üóëÔ∏è
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                if (filteredMovements.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><p>Nessun movimento trovato</p></td></tr>';
                }
            },
            
            // Dashboard
            updateDashboard() {
                // Calculate total inventory value
                let totalValue = 0;
                let lowStockCount = 0;
                
                this.products.forEach(product => {
                    const stock = this.inventory[product.id] || 0;
                    if (product.price) {
                        totalValue += stock * product.price;
                    }
                    if (stock < 5 && stock > 0) {
                        lowStockCount++;
                    }
                });
                
                document.getElementById('totalValue').textContent = '‚Ç¨' + totalValue.toFixed(2);
                document.getElementById('lowStock').textContent = lowStockCount;
                
                // Find last night consumption
                const nightDates = Object.keys(this.nights).sort((a, b) => new Date(b) - new Date(a));
                
                if (nightDates.length > 0) {
                    const lastNight = this.nights[nightDates[0]];
                    let lastNightTotal = 0;
                    
                    Object.entries(lastNight.consumptions).forEach(([productId, quantity]) => {
                        const product = this.products.find(p => p.id === parseInt(productId));
                        if (product && product.price) {
                            lastNightTotal += quantity * product.price;
                        }
                    });
                    
                    document.getElementById('lastNightConsumption').textContent = '‚Ç¨' + lastNightTotal.toFixed(2);
                    document.getElementById('lastNightDate').textContent = new Date(nightDates[0]).toLocaleDateString('it-IT');
                } else {
                    document.getElementById('lastNightConsumption').textContent = '‚Ç¨0.00';
                    document.getElementById('lastNightDate').textContent = 'Nessuna serata registrata';
                }
                
                // Weekly average
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                let weeklyTotal = 0;
                let weeklyNights = 0;
                
                Object.entries(this.nights).forEach(([date, night]) => {
                    if (new Date(date) >= oneWeekAgo) {
                        weeklyNights++;
                        Object.entries(night.consumptions).forEach(([productId, quantity]) => {
                            const product = this.products.find(p => p.id === parseInt(productId));
                            if (product && product.price) {
                                weeklyTotal += quantity * product.price;
                            }
                        });
                    }
                });
                
                const weeklyAverage = weeklyNights > 0 ? weeklyTotal / weeklyNights : 0;
                document.getElementById('weeklyAverage').textContent = '‚Ç¨' + weeklyAverage.toFixed(2);
                
                // Update top products table
                this.updateTopProducts();
            },
updateTopProducts() {
                const tbody = document.querySelector('#topProductsTable tbody');
                tbody.innerHTML = '';
                
                // Calculate consumption by product from nights data
                const consumptionMap = {};
                const lastWeek = new Date();
                lastWeek.setDate(lastWeek.getDate() - 7);
                
                Object.entries(this.nights).forEach(([date, night]) => {
                    if (new Date(date) >= lastWeek) {
                        Object.entries(night.consumptions).forEach(([productId, quantity]) => {
                            if (!consumptionMap[productId]) {
                                consumptionMap[productId] = 0;
                            }
                            consumptionMap[productId] += quantity;
                        });
                    }
                });
                
                // Sort by consumption
                const topProducts = Object.entries(consumptionMap)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                if (topProducts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><p>Nessun dato disponibile. Inizia registrando i movimenti!</p></td></tr>';
                    return;
                }
                
                topProducts.forEach(([productId, consumption]) => {
                    const product = this.products.find(p => p.id === parseInt(productId));
                    if (!product) return;
                    
                    const value = consumption * (product.price || 0);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td><span class="badge badge-${product.category}">${this.getCategoryName(product.category)}</span></td>
                        <td>${consumption.toFixed(2)}L</td>
                        <td>‚Ç¨${value.toFixed(2)}</td>
                        <td>üìà Top</td>
                    `;
                    tbody.appendChild(row);
                });
            },
            
            // Nights functions
            updateNightSelector() {
                const selector = document.getElementById('nightSelector');
                selector.innerHTML = '<option value="">Seleziona una serata...</option>';
                
                const nightDates = Object.keys(this.nights).sort((a, b) => new Date(b) - new Date(a));
                
                nightDates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = new Date(date).toLocaleDateString('it-IT', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    selector.appendChild(option);
                });
            },
            
           showNightDetails() {
                const selectedDate = document.getElementById('nightSelector').value;
                
                if (!selectedDate) {
                    document.getElementById('nightDetailsContainer').style.display = 'none';
                    document.getElementById('deleteNightBtn').style.display = 'none';
                    return;
                }
                
                document.getElementById('nightDetailsContainer').style.display = 'block';
                document.getElementById('deleteNightBtn').style.display = 'block';
                
                const night = this.nights[selectedDate];
                let totalValue = 0;
                let totalLiters = 0;
                let totalBottles = 0;
                const categoryTotals = {};
                this.nightProductDetails = []; // Store for sorting
                
                Object.entries(night.consumptions).forEach(([productId, quantity]) => {
                    const product = this.products.find(p => p.id === parseInt(productId));
                    if (product) {
                        const value = quantity * (product.price || 0);
                        totalValue += value;
                        totalLiters += quantity;
                        totalBottles += quantity / product.format;
                        
                        if (!categoryTotals[product.category]) {
                            categoryTotals[product.category] = 0;
                        }
                        categoryTotals[product.category] += value;
                        
                        this.nightProductDetails.push({
                            product: product,
                            quantity: quantity,
                            bottles: quantity / product.format,
                            value: value,
                            name: product.name,
                            category: product.category,
                            percentage: 0 // Will be calculated after
                        });
                    }
                });
                
                // Calculate percentages
                this.nightProductDetails.forEach(detail => {
                    detail.percentage = totalValue > 0 ? (detail.value / totalValue * 100) : 0;
                });
                
                // Update stats
                document.getElementById('nightTotalConsumption').textContent = '‚Ç¨' + totalValue.toFixed(2);
                document.getElementById('nightBottlesCount').textContent = Math.round(totalBottles);
                document.getElementById('nightTotalLiters').textContent = totalLiters.toFixed(2) + 'L';
                
                // Top category
                const topCategory = Object.entries(categoryTotals)
                    .sort((a, b) => b[1] - a[1])[0];
                document.getElementById('nightTopCategory').textContent = topCategory 
                    ? this.getCategoryName(topCategory[0]) 
                    : '-';
                
                // Initial sort by value
                this.currentSort = { column: 'value', direction: 'desc' };
                this.updateNightProductsTable();
                
                // Setup sorting listeners
                this.setupNightTableSorting();
            },
            
            setupNightTableSorting() {
                const headers = document.querySelectorAll('#nightProductsTable th.sortable');
                headers.forEach(header => {
                    header.onclick = () => {
                        const column = header.dataset.sort;
                        
                        // Remove classes from all headers
                        headers.forEach(h => {
                            h.classList.remove('asc', 'desc');
                        });
                        
                        // Toggle direction
                        if (this.currentSort.column === column) {
                            this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            this.currentSort.column = column;
                            this.currentSort.direction = 'asc';
                        }
                        
                        // Add class to current header
                        header.classList.add(this.currentSort.direction);
                        
                        // Sort and update table
                        this.updateNightProductsTable();
                    };
                });
            },
            
            updateNightProductsTable() {
                const tbody = document.querySelector('#nightProductsTable tbody');
                tbody.innerHTML = '';
                
                // Sort the details
                const sorted = [...this.nightProductDetails].sort((a, b) => {
                    let aVal = a[this.currentSort.column];
                    let bVal = b[this.currentSort.column];
                    
                    // Handle string comparison for name and category
                    if (this.currentSort.column === 'name' || this.currentSort.column === 'category') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    
                    if (this.currentSort.direction === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
                
                sorted.forEach(detail => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${detail.product.name}</td>
                        <td><span class="badge badge-${detail.product.category}">${this.getCategoryName(detail.product.category)}</span></td>
                        <td>${detail.quantity.toFixed(2)}L</td>
                        <td>${detail.bottles.toFixed(1)}</td>
                        <td>‚Ç¨${detail.value.toFixed(2)}</td>
                        <td>${detail.percentage.toFixed(1)}%</td>
                    `;
                    tbody.appendChild(row);
                });
            },
            
            deleteMovement(movementId) {
                if (confirm('Sei sicuro di voler eliminare questo movimento?')) {
                    // Find the movement first
                    const movement = this.movements.find(m => m.id == movementId);
                    
                    // Remove the movement
                    this.movements = this.movements.filter(m => m.id != movementId);
                    
                    // If it's a consumption, update nights
                    if (movement && movement.type === 'consumption') {
                        const nightDate = movement.date.split(' ')[0];
                        if (this.nights[nightDate]) {
                            this.recalculateNight(nightDate);
                        }
                    }
                    
                    // If it's an order or adjustment, recalculate inventory
                    if (movement && (movement.type === 'order' || movement.type === 'adjustment')) {
                        // Recalculate inventory from scratch
                        this.recalculateInventory();
                    }
                    
                    this.saveToStorage();
                    this.updateMovementsTable();
                    this.updateDashboard();
                    this.updateAllTables();
                    this.showAlert('Movimento eliminato con successo', 'success');
                }
            },
            
            clearAllMovements() {
                if (confirm('‚ö†Ô∏è ATTENZIONE: Sei sicuro di voler eliminare TUTTI i movimenti? Questa azione non pu√≤ essere annullata!')) {
                    if (confirm('‚ö†Ô∏è SECONDA CONFERMA: Verranno eliminati tutti i movimenti, le serate e l\'inventario verr√† azzerato. Continuare?')) {
                        // Clear all data
                        this.movements = [];
                        this.nights = {};
                        this.inventory = {};
                        
                        // Save and update
                        this.saveToStorage();
                        this.updateAllTables();
                        this.updateDashboard();
                        this.updateNightSelector();
                        this.showAlert('Tutti i movimenti sono stati eliminati', 'success');
                    }
                }
            },
            
            recalculateInventory() {
                // Reset inventory
                this.inventory = {};
                
                // Recalculate from all movements
                this.movements.forEach(movement => {
                    if (!this.inventory[movement.productId]) {
                        this.inventory[movement.productId] = 0;
                    }
                    this.inventory[movement.productId] += movement.quantity;
                });
                
                // Ensure no negative values
                Object.keys(this.inventory).forEach(productId => {
                    if (this.inventory[productId] < 0) {
                        this.inventory[productId] = 0;
                    }
                });
            },
            
            filterNightProducts() {
                const searchTerm = document.getElementById('nightProductSearch').value.toLowerCase();
                const rows = document.querySelectorAll('#nightProductsTable tbody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            },
            
            deleteNight() {
                const selectedDate = document.getElementById('nightSelector').value;
                if (!selectedDate) return;
                
                if (confirm(`Sei sicuro di voler eliminare la serata del ${new Date(selectedDate).toLocaleDateString('it-IT')}? Questa azione non pu√≤ essere annullata.`)) {
                    // Remove night
                    delete this.nights[selectedDate];
                    
                    // Remove associated movements
                    this.movements = this.movements.filter(m => {
                        if (m.type === 'consumption' && m.date.startsWith(selectedDate)) {
                            return false;
                        }
                        return true;
                    });
                    
                    this.saveToStorage();
                    this.updateNightSelector();
                    this.updateMovementsTable();
                    this.updateDashboard();
                    document.getElementById('nightDetailsContainer').style.display = 'none';
                    this.showAlert('Serata eliminata con successo', 'success');
                }
            },
            
            deleteMovement(movementId) {
                if (confirm('Sei sicuro di voler eliminare questo movimento?')) {
                    const movement = this.movements.find(m => m.id === movementId);
                    this.movements = this.movements.filter(m => m.id !== movementId);
                    
                    // If it's a consumption, update nights
                    if (movement && movement.type === 'consumption') {
                        const nightDate = movement.date.split(' ')[0];
                        if (this.nights[nightDate]) {
                            this.recalculateNight(nightDate);
                        }
                    }
                    
                    this.saveToStorage();
                    this.updateMovementsTable();
                    this.updateDashboard();
                    this.showAlert('Movimento eliminato con successo', 'success');
                }
            },
            
            recalculateNight(date) {
                const nightMovements = this.movements.filter(m => 
                    m.type === 'consumption' && m.date.startsWith(date)
                );
                
                if (nightMovements.length === 0) {
                    delete this.nights[date];
                } else {
                    const consumptions = {};
                    nightMovements.forEach(m => {
                        if (!consumptions[m.productId]) {
                            consumptions[m.productId] = 0;
                        }
                        consumptions[m.productId] += Math.abs(m.quantity);
                    });
                    this.nights[date] = { consumptions };
                }
            },
            
            // Statistics
            populateStatsProductSelect() {
                const select = document.getElementById('statsProduct');
                select.innerHTML = '<option value="">Tutti i prodotti</option>';
                this.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    select.appendChild(option);
                });
            },
            
            updateCharts() {
                const period = parseInt(document.getElementById('statsPeriod').value);
                const productId = document.getElementById('statsProduct').value;
                
                // Destroy existing charts
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                
                this.updateTopProductsChart(period);
                this.updateConsumptionTrendChart(period, productId);
                this.updateCategoryPieChart(period);
            },
updateTopProductsChart(period) {
                const ctx = document.getElementById('topProductsChart').getContext('2d');
                const consumptionData = this.getConsumptionData(period);
                
                const sorted = Object.entries(consumptionData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 20);
                
                const labels = sorted.map(([productId]) => {
                    const product = this.products.find(p => p.id === parseInt(productId));
                    return product ? product.name : 'Sconosciuto';
                });
                
                const data = sorted.map(([_, value]) => value);
                
                this.charts.topProducts = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Consumo (L)',
                            data: data,
                            backgroundColor: 'rgba(139, 92, 246, 0.6)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#f3f4f6',
                                    autoSkip: false,
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#f3f4f6'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            },
            
            updateConsumptionTrendChart(period, productId) {
                const ctx = document.getElementById('consumptionTrendChart').getContext('2d');
                const trendData = this.getTrendData(period, productId);
                
                this.charts.trend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: trendData.labels,
                        datasets: [{
                            label: productId ? 'Consumo prodotto (L)' : 'Consumo totale (‚Ç¨)',
                            data: trendData.values,
                            borderColor: 'rgba(236, 72, 153, 1)',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#f3f4f6'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#f3f4f6'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#f3f4f6'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            },
            
            updateCategoryPieChart(period) {
                const ctx = document.getElementById('categoryPieChart').getContext('2d');
                const categoryData = this.getCategoryData(period);
                
                this.charts.pie = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categoryData).map(cat => this.getCategoryName(cat)),
                        datasets: [{
                            data: Object.values(categoryData),
                            backgroundColor: [
                                'rgba(252, 165, 165, 0.6)',
                                'rgba(147, 197, 253, 0.6)',
                                'rgba(252, 211, 77, 0.6)',
                                'rgba(251, 191, 36, 0.6)',
                                'rgba(110, 231, 183, 0.6)',
                                'rgba(192, 132, 252, 0.6)',
                                'rgba(249, 168, 212, 0.6)',
                                'rgba(103, 232, 249, 0.6)',
                                'rgba(252, 165, 165, 0.6)',
                                'rgba(253, 186, 116, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: '#f3f4f6'
                                }
                            }
                        }
                    }
                });
            },
            
            getConsumptionData(period) {
                const consumptionMap = {};
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - (period === 'all' ? 365 : period));
                
                Object.entries(this.nights).forEach(([date, night]) => {
                    if (period === 'all' || new Date(date) >= startDate) {
                        Object.entries(night.consumptions).forEach(([productId, quantity]) => {
                            if (!consumptionMap[productId]) {
                                consumptionMap[productId] = 0;
                            }
                            consumptionMap[productId] += quantity;
                        });
                    }
                });
                
                return consumptionMap;
            },
            
            getTrendData(period, productId) {
                const labels = [];
                const values = [];
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - (period === 'all' ? 365 : period));
                
                const nightDates = Object.keys(this.nights)
                    .filter(date => period === 'all' || new Date(date) >= startDate)
                    .sort();
                
                nightDates.forEach(date => {
                    labels.push(new Date(date).toLocaleDateString('it-IT'));
                    
                    if (productId) {
                        values.push(this.nights[date].consumptions[productId] || 0);
                    } else {
                        let total = 0;
                        Object.entries(this.nights[date].consumptions).forEach(([pid, quantity]) => {
                            const product = this.products.find(p => p.id === parseInt(pid));
                            if (product && product.price) {
                                total += quantity * product.price;
                            }
                        });
                        values.push(total);
                    }
                });
                
                return { labels, values };
            },
            
            getCategoryData(period) {
                const categoryMap = {};
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - (period === 'all' ? 365 : period));
                
                Object.entries(this.nights).forEach(([date, night]) => {
                    if (period === 'all' || new Date(date) >= startDate) {
                        Object.entries(night.consumptions).forEach(([productId, quantity]) => {
                            const product = this.products.find(p => p.id === parseInt(productId));
                            if (product && product.price) {
                                if (!categoryMap[product.category]) {
                                    categoryMap[product.category] = 0;
                                }
                                categoryMap[product.category] += quantity * product.price;
                            }
                        });
                    }
                });
                
                return categoryMap;
            },
            
            // Report Generation
            generateReport() {
                const reportType = document.getElementById('reportType').value;
                const reportPeriod = document.getElementById('reportPeriod').value;
                const reportFormat = document.getElementById('reportFormat').value;
                
                let data = [];
                let filename = `cambusa_report_${reportType}_${new Date().toISOString().split('T')[0]}`;
                
                switch (reportType) {
                    case 'inventory':
                        data = this.generateInventoryReport();
                        break;
                    case 'consumption':
                        data = this.generateConsumptionReport(reportPeriod);
                        break;
                    case 'night':
                        data = this.generateNightReport();
                        break;
                    case 'product':
                        data = this.generateProductReport();
                        break;
                }
                
                switch (reportFormat) {
                    case 'csv':
                        this.downloadCSV(data, filename + '.csv');
                        break;
                    case 'json':
                        this.downloadJSON(data, filename + '.json');
                        break;
                    case 'txt':
                        this.downloadTXT(data, filename + '.txt');
                        break;
                }
                
                this.showAlert('Report generato e scaricato con successo!', 'success');
            },
            
            generateInventoryReport() {
                return this.products.map(product => ({
                    Prodotto: product.name,
                    Categoria: this.getCategoryName(product.category),
                    Formato: product.format + 'L',
                    Prezzo: product.price || 0,
                    Giacenza: this.inventory[product.id] || 0,
                    Valore: ((this.inventory[product.id] || 0) * (product.price || 0)).toFixed(2)
                }));
            },
            
            generateConsumptionReport(period) {
                const consumptionData = this.getConsumptionData(period === 'all' ? 'all' : 30);
                
                return Object.entries(consumptionData).map(([productId, quantity]) => {
                    const product = this.products.find(p => p.id === parseInt(productId));
                    return {
                        Prodotto: product ? product.name : 'Sconosciuto',
                        Categoria: product ? this.getCategoryName(product.category) : '-',
                        'Quantit√† Consumata (L)': quantity.toFixed(2),
                        'Valore (‚Ç¨)': product ? (quantity * product.price).toFixed(2) : '0.00'
                    };
                });
            },
            
            generateNightReport() {
                const report = [];
                const nightDates = Object.keys(this.nights).sort((a, b) => new Date(b) - new Date(a));
                
                nightDates.forEach(date => {
                    let totalValue = 0;
                    let totalLiters = 0;
                    
                    Object.entries(this.nights[date].consumptions).forEach(([productId, quantity]) => {
                        const product = this.products.find(p => p.id === parseInt(productId));
                        if (product) {
                            totalValue += quantity * (product.price || 0);
                            totalLiters += quantity;
                        }
                    });
                    
                    report.push({
                        Data: new Date(date).toLocaleDateString('it-IT'),
                        'Totale Consumo (‚Ç¨)': totalValue.toFixed(2),
                        'Litri Totali': totalLiters.toFixed(2),
                        'Numero Prodotti': Object.keys(this.nights[date].consumptions).length
                    });
                });
                
                return report;
            },
            
            generateProductReport() {
                const report = [];
                
                this.products.forEach(product => {
                    let totalConsumed = 0;
                    let nightsCount = 0;
                    
                    Object.values(this.nights).forEach(night => {
                        if (night.consumptions[product.id]) {
                            totalConsumed += night.consumptions[product.id];
                            nightsCount++;
                        }
                    });
                    
                    if (totalConsumed > 0) {
                        report.push({
                            Prodotto: product.name,
                            Categoria: this.getCategoryName(product.category),
                            'Consumo Totale (L)': totalConsumed.toFixed(2),
                            'Valore Totale (‚Ç¨)': (totalConsumed * (product.price || 0)).toFixed(2),
                            'Serate con Consumo': nightsCount,
                            'Media per Serata (L)': (totalConsumed / nightsCount).toFixed(2)
                        });
                    }
                });
                
                return report.sort((a, b) => parseFloat(b['Valore Totale (‚Ç¨)']) - parseFloat(a['Valore Totale (‚Ç¨)']));
            },
downloadCSV(data, filename) {
                if (data.length === 0) return;
                
                const headers = Object.keys(data[0]);
                const csv = [
                    headers.join(','),
                    ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
                ].join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            },
            
            downloadJSON(data, filename) {
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            },
            
            downloadTXT(data, filename) {
                let txt = '';
                data.forEach(row => {
                    txt += Object.entries(row).map(([key, value]) => `${key}: ${value}`).join(' | ') + '\n';
                });
                
                const blob = new Blob([txt], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            },
            
            // Modal Functions
            showInitialInventoryModal() {
                const form = document.getElementById('initialInventoryForm');
                form.innerHTML = '';
                
                // Group products by category
                const categories = {};
                this.products.forEach(product => {
                    if (!categories[product.category]) {
                        categories[product.category] = [];
                    }
                    categories[product.category].push(product);
                });
                
                Object.entries(categories).forEach(([category, products]) => {
                    const section = document.createElement('div');
                    section.className = 'card';
                    section.innerHTML = `<h3>${this.getCategoryName(category)}</h3>`;
                    
                    const grid = document.createElement('div');
                    grid.className = 'form-grid';
                    
                    products.forEach(product => {
                        const currentStock = this.inventory[product.id] || 0;
                        const group = document.createElement('div');
                        group.className = 'form-group';
                        group.innerHTML = `
                            <label>${product.name} (${product.format}L)</label>
                            <input type="number" 
                                id="initial_${product.id}" 
                                value="${currentStock}" 
                                step="0.01" 
                                min="0"
                                placeholder="0">
                        `;
                        grid.appendChild(group);
                    });
                    
                    section.appendChild(grid);
                    form.appendChild(section);
                });
                
                document.getElementById('initialInventoryModal').classList.add('active');
            },
            
            showEndOfNightModal() {
                const form = document.getElementById('endOfNightForm');
                form.innerHTML = '';
                
                // Group products by category
                const categories = {};
                this.products.forEach(product => {
                    if (!categories[product.category]) {
                        categories[product.category] = [];
                    }
                    categories[product.category].push(product);
                });
                
                Object.entries(categories).forEach(([category, products]) => {
                    const section = document.createElement('div');
                    section.className = 'card';
                    section.innerHTML = `<h3>${this.getCategoryName(category)}</h3>`;
                    
                    const grid = document.createElement('div');
                    grid.className = 'form-grid';
                    
                    products.forEach(product => {
                        const currentStock = this.inventory[product.id] || 0;
                        const group = document.createElement('div');
                        group.className = 'form-group';
                        group.innerHTML = `
                            <label>${product.name} (${product.format}L)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="number" 
                                    id="endnight_${product.id}" 
                                    value="${currentStock}" 
                                    step="0.01" 
                                    min="0"
                                    placeholder="0"
                                    style="flex: 1">
                                <span style="color: var(--gray);">Attuale: ${currentStock.toFixed(2)}L</span>
                            </div>
                        `;
                        grid.appendChild(group);
                    });
                    
                    section.appendChild(grid);
                    form.appendChild(section);
                });
                
                document.getElementById('endOfNightModal').classList.add('active');
            },
            
            showOrderModal() {
                document.getElementById('orderItems').innerHTML = '';
                this.addOrderItem();
                document.getElementById('orderModal').classList.add('active');
            },
            
            showAddProductModal() {
                document.getElementById('addProductModal').classList.add('active');
            },
            
            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            },
            
            // Save Functions
            saveInitialInventory() {
                this.products.forEach(product => {
                    const input = document.getElementById(`initial_${product.id}`);
                    if (input) {
                        const quantity = parseFloat(input.value) || 0;
                        this.inventory[product.id] = quantity;
                    }
                });
                
                this.saveToStorage();
                this.updateAllTables();
                this.updateDashboard();
                this.closeModal('initialInventoryModal');
                this.showAlert('Giacenza iniziale salvata con successo!', 'success');
            },
            
            saveEndOfNight() {
                const nightDate = document.getElementById('nightDate').value;
                if (!nightDate) {
                    this.showAlert('Inserisci la data della serata', 'error');
                    return;
                }
                
                const consumptions = [];
                const nightConsumptions = {};
                
                this.products.forEach(product => {
                    const input = document.getElementById(`endnight_${product.id}`);
                    if (input) {
                        const finalStock = parseFloat(input.value) || 0;
                        const initialStock = this.inventory[product.id] || 0;
                        const consumption = initialStock - finalStock;
                        
                        if (consumption > 0) {
                            consumptions.push({
                                id: Date.now() + Math.random(),
                                date: nightDate + ' 23:59:59',
                                type: 'consumption',
                                productId: product.id,
                                quantity: -consumption,
                                note: 'Consumo serata',
                                operator: 'Sistema'
                            });
                            
                            nightConsumptions[product.id] = consumption;
                            
                            // Update inventory
                            this.inventory[product.id] = finalStock;
                        } else if (consumption < 0) {
                            // If final stock is higher than initial, update inventory
                            this.inventory[product.id] = finalStock;
                        }
                    }
                });
                
                if (Object.keys(nightConsumptions).length > 0) {
                    // Save night data
                    this.nights[nightDate] = {
                        consumptions: nightConsumptions
                    };
                    
                    // Add all consumptions to movements
                    this.movements.push(...consumptions);
                    
                    this.saveToStorage();
                    this.updateAllTables();
                    this.updateDashboard();
                    this.updateNightSelector();
                    this.closeModal('endOfNightModal');
                    
                    // Calculate total consumption value
                    let totalConsumption = 0;
                    Object.entries(nightConsumptions).forEach(([productId, quantity]) => {
                        const product = this.products.find(p => p.id === parseInt(productId));
                        if (product && product.price) {
                            totalConsumption += quantity * product.price;
                        }
                    });
                    
                    this.showAlert(`Consumi della serata registrati! Totale: ‚Ç¨${totalConsumption.toFixed(2)}`, 'success');
                } else {
                    this.showAlert('Nessun consumo registrato per questa serata', 'warning');
                }
            },
            
            saveOrder() {
                const supplier = document.getElementById('orderSupplier').value;
                const orderDate = document.getElementById('orderDate').value;
                
                if (!supplier || !orderDate) {
                    this.showAlert('Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                const orderItems = document.querySelectorAll('.order-item');
                const movements = [];
                
                orderItems.forEach(item => {
                    const productId = parseInt(item.querySelector('.order-product').value);
                    const quantity = parseFloat(item.querySelector('.order-quantity').value) || 0;
                    
                    if (productId && quantity > 0) {
                        movements.push({
                            id: Date.now() + Math.random(),
                            date: orderDate + ' 12:00:00',
                            type: 'order',
                            productId: productId,
                            quantity: quantity,
                            note: `Ordine da ${supplier}`,
                            operator: 'Sistema'
                        });
                        
                        // Update inventory
                        if (!this.inventory[productId]) {
                            this.inventory[productId] = 0;
                        }
                        this.inventory[productId] += quantity;
                    }
                });
                
                if (movements.length === 0) {
                    this.showAlert('Aggiungi almeno un prodotto all\'ordine', 'error');
                    return;
                }
                
                this.movements.push(...movements);
                this.saveToStorage();
                this.updateAllTables();
                this.updateDashboard();
                this.closeModal('orderModal');
                this.showAlert('Ordine registrato con successo!', 'success');
            },
saveNewProduct() {
                const name = document.getElementById('newProductName').value;
                const category = document.getElementById('newProductCategory').value;
                const format = parseFloat(document.getElementById('newProductFormat').value);
                const price = parseFloat(document.getElementById('newProductPrice').value);
                
                if (!name || !category || !format) {
                    this.showAlert('Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                const newProduct = {
                    id: Date.now(),
                    name: name.toUpperCase(),
                    category: category,
                    format: format,
                    price: price || null
                };
                
                this.products.push(newProduct);
                this.saveToStorage();
                this.updateProductsTable();
                this.populateStatsProductSelect();
                this.closeModal('addProductModal');
                this.showAlert('Prodotto aggiunto con successo!', 'success');
                
                // Clear form
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductFormat').value = '';
                document.getElementById('newProductPrice').value = '';
            },
            
            // Order Item Management
            addOrderItem() {
                const container = document.getElementById('orderItems');
                const itemDiv = document.createElement('div');
                itemDiv.className = 'order-item form-grid';
                itemDiv.style.marginBottom = '15px';
                
                itemDiv.innerHTML = `
                    <div class="form-group" style="flex: 2;">
                        <label>Prodotto</label>
                        <select class="order-product">
                            <option value="">Seleziona prodotto</option>
                            ${this.products.map(p => 
                                `<option value="${p.id}">${p.name} (${p.format}L)</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantit√† (L)</label>
                        <input type="number" class="order-quantity" step="0.01" min="0" placeholder="0">
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">
                            üóëÔ∏è Rimuovi
                        </button>
                    </div>
                `;
                
                container.appendChild(itemDiv);
            },
            
            // Inventory Adjustment
            adjustInventory(productId) {
                const product = this.products.find(p => p.id === productId);
                const currentStock = this.inventory[productId] || 0;
                
                const newStock = prompt(`Modifica giacenza per ${product.name}\nGiacenza attuale: ${currentStock.toFixed(2)}L\nNuova giacenza:`, currentStock);
                
                if (newStock !== null) {
                    const quantity = parseFloat(newStock);
                    if (!isNaN(quantity) && quantity >= 0) {
                        const difference = quantity - currentStock;
                        
                        if (difference !== 0) {
                            this.movements.push({
                                id: Date.now().toString(),
                                date: new Date().toISOString(),
                                type: 'adjustment',
                                productId: productId,
                                quantity: difference,
                                note: 'Rettifica manuale inventario',
                                operator: 'Utente'
                            });
                        }
                        
                        this.inventory[productId] = quantity;
                        this.saveToStorage();
                        this.updateAllTables();
                        this.updateDashboard();
                        this.showAlert('Giacenza aggiornata con successo!', 'success');
                    }
                }
            },
            
            // Product Editing
            editProduct(productId) {
                const product = this.products.find(p => p.id === productId);
                const newPrice = prompt(`Modifica prezzo per ${product.name}\nPrezzo attuale: ‚Ç¨${product.price || 'N/D'}\nNuovo prezzo:`, product.price || '');
                
                if (newPrice !== null) {
                    const price = parseFloat(newPrice);
                    if (!isNaN(price) && price >= 0) {
                        product.price = price;
                        this.saveToStorage();
                        this.updateProductsTable();
                        this.updateDashboard();
                        this.showAlert('Prezzo aggiornato con successo!', 'success');
                    }
                }
            },
            
            // Utility Functions
            getCategoryName(category) {
                const names = {
                    vodka: 'Vodka',
                    gin: 'Gin',
                    rum: 'Rum',
                    whisky: 'Whisky',
                    tequila: 'Tequila',
                    liquori: 'Liquori',
                    champagne: 'Champagne/Spumanti',
                    analcolici: 'Analcolici',
                    energy: 'Energy Drink',
                    succhi: 'Succhi'
                };
                return names[category] || category;
            },
            
            getMovementTypeName(type) {
                const names = {
                    consumption: 'üìâ Consumo',
                    order: 'üì¶ Ordine',
                    adjustment: 'üîß Rettifica'
                };
                return names[type] || type;
            },
            
            getStockStatus(stock, product) {
                if (stock === 0) return '<span style="color: var(--danger);">‚ùå Esaurito</span>';
                if (stock < 5) return '<span style="color: var(--warning);">‚ö†Ô∏è Scorta bassa</span>';
                return '<span style="color: var(--success);">‚úÖ Disponibile</span>';
            },
            
            filterTable(tableId, searchTerm) {
                const rows = document.querySelectorAll(`#${tableId} tbody tr`);
                const term = searchTerm.toLowerCase();
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(term) ? '' : 'none';
                });
            },
            
            showAlert(message, type = 'info') {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `
                    ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} ${message}
                `;
                
                document.body.appendChild(alert);
                alert.style.position = 'fixed';
                alert.style.top = '20px';
                alert.style.right = '20px';
                alert.style.zIndex = '2000';
                alert.style.maxWidth = '400px';
                
                setTimeout(() => {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateX(100px)';
                    setTimeout(() => alert.remove(), 300);
                }, 3000);
            }
        };
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
